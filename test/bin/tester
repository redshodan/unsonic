#!/usr/bin/env python3

import os
import tempfile
import argparse


host = "http://0.0.0.0:6543/"
auth_test = "u=test&t=c06db68e819be6ec3d26c6038d8e8d1f&s=12345"
auth_admin = "u=admin&t=7488e331b8b64e5794da3fa4eb10ad5d&s=12345"


parser = argparse.ArgumentParser(description='Make API calls to Unsonic.')
parser.add_argument('endpoint', type=str, nargs='?', default="ping",
                    help='API endpoint to talk to')
parser.add_argument('params', type=str, nargs='*',
                    help='Parameters for the endpoint')
parser.add_argument('-s', '--shares', action='store_true', default=False,
                    help='Use the /shares/ endpoints.')
parser.add_argument('-a', '--admin', action='store_true', default=False,
                    help='Use admin user')

args = parser.parse_args()

if args.shares:
    args.root = "shares"
else:
    args.root = "rest"
    args.endpoint = args.endpoint + ".view"

outfile = tempfile.NamedTemporaryFile()

cmd = "wget --tries=1 --quiet -O %s '%s%s/%s?%s" % (
    outfile.name, host, args.root, args.endpoint,
    auth_admin if args.admin else auth_test)

for param in args.params:
    cmd += "&" + param
cmd += "'"

print(cmd)
os.system(cmd)

if args.shares:
    os.system(f"cat {outfile.name}")
else:
    os.system("xmllint --format --schema test/xsd/unsonic-subsonic-api.xsd %s" %
              outfile.name)
